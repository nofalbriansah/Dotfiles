---
# --- ARCHLINUX / CACHYOS LOGIC ---
- name: "ARCH | System and AUR Package Management"
  block:
    # 1. Full System Upgrade (Equivalent to pacman -Syu)
    # This prevents partial upgrades which are dangerous in Arch
    - name: "ARCH | Update Package Cache & Upgrade System"
      become: true
      ansible.builtin.pacman:
        update_cache: true
        upgrade: true

    # 2. Manage System Packages (Pacman)
    # Loops through the sys_packages list to install or remove
    - name: "ARCH | Sync System Packages"
      become: true
      ansible.builtin.pacman:
        name: "{{ item.name }}"
        state: "{{ item.state | default('present') }}"
      loop: "{{ sys_packages }}"

    # 3. Install AUR Packages (Paru)
    # Uses 'become: false' because AUR helpers shouldn't run as root
    - name: "ARCH | Install AUR Packages"
      ansible.builtin.command: "paru -S --noconfirm --needed {{ item.name }}"
      loop: "{{ aur_packages }}"
      when: item.state == 'present'
      register: aur_inst
      changed_when: "'Installing' in aur_inst.stdout or 'Upgrading' in aur_inst.stdout"
      become: false

    # 4. Remove AUR Packages
    # Ensures packages marked 'absent' are purged with dependencies (-Rns)
    - name: "ARCH | Remove AUR Packages"
      ansible.builtin.command: "paru -Rns --noconfirm {{ item.name }}"
      loop: "{{ aur_packages }}"
      when: item.state == 'absent'
      register: aur_rem
      failed_when: false
      changed_when: "aur_rem.rc == 0"
      become: false

  # Block execution guard
  when: ansible_facts['distribution'] in ["Archlinux", "CachyOS"]
