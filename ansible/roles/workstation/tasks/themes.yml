---
# 1. Ensure standard XDG data directories exist
- name: "THEME | Ensure local directories exist"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ xdg_data_dir }}/icons"
    - "{{ xdg_data_dir }}/themes"
    - "{{ xdg_data_dir }}/backgrounds"

# --- ICONS & CURSORS ---

# 2. Find all icon and cursor folders in the repository
- name: "THEME | Find icons and cursors in repo"
  ansible.builtin.find:
    paths:
      - "{{ playbook_dir }}/files/themes/icons"
      - "{{ playbook_dir }}/files/themes/cursor"
    file_type: directory
    recurse: false
  register: repo_themes

# Task 1: Check if target icon directories are actual directories (not symlinks)
- name: "THEME | Task 1: Check icon destination status"
  ansible.builtin.stat:
    path: "{{ xdg_data_dir }}/icons/{{ item.path | basename }}"
  register: icon_dest_stats
  loop: "{{ repo_themes.files }}"

# Task 2: Remove if it is a real physical directory to prevent symlink blockages
- name: "THEME | Task 2: Remove physical icon directories"
  ansible.builtin.file:
    path: "{{ item.stat.path }}"
    state: absent
  when:
    - item.stat.exists
    - item.stat.isdir
    - not item.stat.islnk
  loop: "{{ icon_dest_stats.results }}"

# Task 3: Create the symlink for Icons and Cursors
- name: "THEME | Task 3: Symlink Icons and Cursors"
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ xdg_data_dir }}/icons/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ repo_themes.files }}"

# --- GTK THEMES ---

# Find GTK themes in repo
- name: "THEME | Find GTK themes in repo"
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/files/themes/themes"
    file_type: directory
  register: repo_gtk

# Task 1: Check if target GTK theme directories are actual directories
- name: "THEME | Task 1: Check GTK theme destination status"
  ansible.builtin.stat:
    path: "{{ xdg_data_dir }}/themes/{{ item.path | basename }}"
  register: gtk_dest_stats
  loop: "{{ repo_gtk.files }}"

# Task 2: Remove physical GTK directories
- name: "THEME | Task 2: Remove physical GTK directories"
  ansible.builtin.file:
    path: "{{ item.stat.path }}"
    state: absent
  when:
    - item.stat.exists
    - item.stat.isdir
    - not item.stat.islnk
  loop: "{{ gtk_dest_stats.results }}"

# Task 3: Create symlinks for GTK Themes
- name: "THEME | Task 3: Symlink GTK Themes"
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ xdg_data_dir }}/themes/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ repo_gtk.files }}"

# --- BACKGROUNDS ---

# Backgrounds are usually files, so "Check-Clean" for directories is usually not needed
# unless you previously had a folder with the same name as a wallpaper file.
- name: "THEME | Find backgrounds in repo"
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/files/themes/backgrounds"
    file_type: file
  register: repo_backgrounds

- name: "THEME | Symlink Backgrounds"
  ansible.builtin.file:
    src: "{{ item.path }}"
    dest: "{{ xdg_data_dir }}/backgrounds/{{ item.path | basename }}"
    state: link
    force: true
  loop: "{{ repo_backgrounds.files }}"
